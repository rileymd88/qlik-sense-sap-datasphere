{"blocks":[{"id":"1136F176-FB65-492D-AABA-5B3269F2B865","type":"StartBlock","disabled":false,"name":"Start","displayName":"Start","comment":"","childId":"2650D9C3-4BF5-4B7B-B651-FFA6B4A61BA2","inputs":[{"id":"run_mode","value":"triggered","type":"select","structure":{}},{"id":"async","value":"no","type":"select","structure":{}},{"id":"","value":null,"type":"custom","structure":{}}],"settings":[{"id":"automations_censor_data","value":false,"type":"checkbox","structure":{}}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-35,"y":-768},{"id":"F64C67C6-D311-4916-9D7B-800B22CFF2F5","type":"OpenFileBlock","disabled":false,"name":"openFile2","displayName":"{$.filePath} - Open File 2 on Microsoft OneDrive","comment":"","childId":"19083EBA-6FDD-45BA-A3D2-2B6CB0DCC7B0","inputs":[{"id":"datasourcetype","value":"Microsoft OneDrive","type":"select","structure":[]},{"id":"path","value":"{$.filePath}","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"datasource","value":"98c1d1c7-21c8-45e7-addd-3820d0724633","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-111,"y":442},{"id":"19083EBA-6FDD-45BA-A3D2-2B6CB0DCC7B0","type":"ReadDataFromFileBlock","disabled":false,"name":"readDataFromFile2","displayName":"{$.filePath} - Read Data From File 2 on Microsoft OneDrive","comment":"","childId":"D5563DCD-B394-4DCB-B263-F6A75FC00E2E","inputs":[{"id":"file","value":"F64C67C6-D311-4916-9D7B-800B22CFF2F5","type":"select","displayValue":"Open File 2 on Microsoft OneDrive (./Automations/datasphere.json)","structure":[]},{"id":"mode","value":"auto","type":"select","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-389,"y":191,"loopBlockId":null},{"id":"D5563DCD-B394-4DCB-B263-F6A75FC00E2E","type":"IfElseBlock","disabled":false,"name":"condition","displayName":"Condition","comment":"If token is expired, grab new token","childId":"3D6B8028-85D7-4A81-B5F1-0CF51C7C2B3B","inputs":[{"id":"conditions","value":{"mode":"all","conditions":[{"input1":"{add: {$.readDataFromFile2.expires_in}, $.readDataFromFile2.created_at}","input2":"{$.customCode}","operator":"<"}]},"type":"custom","structure":[]}],"settings":[],"collapsed":[{"name":"both","isCollapsed":false},{"name":"yes","isCollapsed":false},{"name":"no","isCollapsed":false}],"x":-430,"y":176,"childTrueId":"2DD170DF-530B-4072-B43A-4758FE7AF0B2","childFalseId":"E3A45D38-0A77-4980-A185-15954B2DA30B"},{"id":"357BEE3F-6EB6-4708-ACA0-331307D12BE3","type":"CustomCodeBlock3","disabled":false,"name":"customCode","displayName":"Custom Code","comment":"Get current time","childId":"F64C67C6-D311-4916-9D7B-800B22CFF2F5","inputs":[{"id":"language","value":"python","type":"select","displayValue":"Python 3.11","structure":[]},{"id":"inputs","value":[],"type":"object","mode":"keyValue","structure":[]},{"id":"code","value":"# Example code\nimport time\n\nepoch_time = int(time.time())\nprint(epoch_time)","type":"code","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-434,"y":185},{"id":"B3B0A3E2-9346-4297-95CC-D2DE550DE111","type":"VariableBlock","disabled":false,"name":"clientId","displayName":"Variable - clientId","comment":"Set client id","childId":"A6DEF6AD-E369-4185-AC32-78FA3901FBDC","inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-35,"y":-288,"variableGuid":"7A6082F2-5144-4D46-B83F-82A5E1A12587","operations":[{"id":"set_value","key":"F9A92154-2943-43BD-BEFA-7F2FDCF3814E","name":"Set value of { variable }","value":"YOUR_CLIENT_ID"}]},{"id":"A6DEF6AD-E369-4185-AC32-78FA3901FBDC","type":"VariableBlock","disabled":false,"name":"clientSecret","displayName":"Variable - clientSecret","comment":"Set client secret","childId":"1056CFA1-C790-42FE-8EE6-578988884C07","inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":146,"y":87,"variableGuid":"21900FA7-28EB-4332-9988-F37BDAA932EB","operations":[{"id":"set_value","key":"F9A92154-2943-43BD-BEFA-7F2FDCF3814E","name":"Set value of { variable }","value":"YOUR_CLIENT_SECRET"}]},{"id":"2DD170DF-530B-4072-B43A-4758FE7AF0B2","type":"CallUrlBlock","disabled":false,"name":"callURL","displayName":"Call URL","comment":"Get new token","childId":"E28B0339-6D6A-43A4-82D0-C1428ABA3DF1","inputs":[{"id":"url","value":"https://{$.inputs.site_name}.authentication.eu10.hana.ondemand.com/oauth/token","type":"string","structure":[]},{"id":"method","value":"POST","type":"select","displayValue":"POST","structure":[]},{"id":"timeout","value":"","type":"string","structure":[]},{"id":"params","value":"grant_type=refresh_token&refresh_token={$.readDataFromFile2.refresh_token}","type":"object","mode":"raw","structure":[]},{"id":"headers","value":[{"key":"Content-Type","value":"application/x-www-form-urlencoded"},{"key":"Authorization","value":"Basic {$.customCode2}"}],"type":"object","mode":"keyValue","structure":[]},{"id":"encoding","value":"","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"full_response","value":null,"type":"checkbox","structure":[]},{"id":"capitalize_headers","value":true,"type":"checkbox","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-390,"y":581},{"id":"1056CFA1-C790-42FE-8EE6-578988884C07","type":"CustomCodeBlock3","disabled":false,"name":"customCode2","displayName":"Custom Code 2","comment":"Get base64 basic auth","childId":"357BEE3F-6EB6-4708-ACA0-331307D12BE3","inputs":[{"id":"language","value":"python","type":"select","displayValue":"Python 3.11","structure":[]},{"id":"inputs","value":[{"key":"client_id","value":"{$.clientId}"},{"key":"client_secret","value":"{$.clientSecret}"}],"type":"object","mode":"keyValue","structure":[]},{"id":"code","value":"import base64\n\n# Replace 'your_username' and 'your_password' with your actual credentials\nclient_id = inputs['client_id']\nclient_secret = inputs['client_secret']\n\n# Step 1: Concatenate username and password with a colon\ncredentials = f'{client_id}:{client_secret}'\n\n# Step 2: Encode the credentials to bytes using UTF-8\ncredentials_bytes = credentials.encode('utf-8')\n\n# Step 3: Base64-encode the byte string\nbase64_bytes = base64.b64encode(credentials_bytes)\n\n# Step 4: Decode the base64 bytes back to a string\nbase64_credentials = base64_bytes.decode('utf-8')\n\nprint(base64_credentials)","type":"code","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-390,"y":207},{"id":"9039DA5A-A09A-4B62-B86A-60991CF667B9","type":"CreateFileBlock","disabled":false,"name":"createFile2","displayName":"{$.filePath} - Create File 2 on Microsoft OneDrive","comment":"","childId":"E9D7AC91-BFED-42A6-80D3-DE2DDDE2EB58","inputs":[{"id":"datasourcetype","value":"Microsoft OneDrive","type":"select","displayValue":"Microsoft OneDrive","structure":[]},{"id":"path","value":"{$.filePath}","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"datasource","value":"98c1d1c7-21c8-45e7-addd-3820d0724633","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-373,"y":807},{"id":"71F2EE64-5C21-4F2A-AD72-40675EBB751E","type":"VariableBlock","disabled":false,"name":"filePath","displayName":"Variable - filePath","comment":"Set file path\n","childId":"B3B0A3E2-9346-4297-95CC-D2DE550DE111","inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-35,"y":-408,"variableGuid":"8249BD43-D54B-4F65-8461-6135162BEA1B","operations":[{"id":"set_value","key":"F9A92154-2943-43BD-BEFA-7F2FDCF3814E","name":"Set value of { variable }","value":"./Automations/datasphere.json"}]},{"id":"E28B0339-6D6A-43A4-82D0-C1428ABA3DF1","type":"DeleteFileBlock","disabled":false,"name":"deleteFile","displayName":"{$.filePath} - Delete File on Microsoft OneDrive","comment":"","childId":"9039DA5A-A09A-4B62-B86A-60991CF667B9","inputs":[{"id":"datasourcetype","value":"Microsoft OneDrive","type":"select","displayValue":"Microsoft OneDrive","structure":[]},{"id":"path","value":"{$.filePath}","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"datasource","value":"98c1d1c7-21c8-45e7-addd-3820d0724633","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-437,"y":1294},{"id":"E9D7AC91-BFED-42A6-80D3-DE2DDDE2EB58","type":"WriteLineToFileBlock","disabled":false,"name":"writeLineToFile2","displayName":"{$.filePath} - Write Line To File 2 on Microsoft OneDrive","comment":"","childId":"F5BA5D59-A6E4-497E-AB56-0F3AF8073B7E","inputs":[{"id":"file","value":"9039DA5A-A09A-4B62-B86A-60991CF667B9","type":"select","displayValue":"Create File 2 on Microsoft OneDrive ({$.filePath})","structure":[]},{"id":"data","value":"{\"access_token\":\"{$.callURL.access_token}\",\n\"refresh_token\":\"{$.callURL.refresh_token}\",\n\"expires_in\":{$.callURL.expires_in},\n\"created_at\":{$.customCode}\n}","type":"string","structure":[]},{"id":"mode","value":"raw","type":"select","displayValue":"Raw (line-by-line)","structure":[]},{"id":"file_encoding","value":"","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-404,"y":1186},{"id":"F5BA5D59-A6E4-497E-AB56-0F3AF8073B7E","type":"CloseFileBlock","disabled":false,"name":"saveAndCloseFile","displayName":"{$.filePath} - Save And Close File on Microsoft OneDrive","comment":"","childId":"41D455E9-B904-43B6-81E8-3C28F9762A0D","inputs":[{"id":"file","value":"9039DA5A-A09A-4B62-B86A-60991CF667B9","type":"select","displayValue":"Create File 2 on Microsoft OneDrive ({$.filePath})","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-394,"y":1266},{"id":"2650D9C3-4BF5-4B7B-B651-FFA6B4A61BA2","type":"FormBlock","disabled":false,"name":"inputs","displayName":"Inputs","comment":"","childId":"71F2EE64-5C21-4F2A-AD72-40675EBB751E","inputs":[],"settings":[{"id":"persist_data","value":"no","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":408,"y":52,"form":[{"id":"inputs-input-0","label":"space","helpText":"SAP Space Name","type":"input","values":null,"isRequired":true,"options":{},"order":0},{"id":"inputs-input-1","label":"asset","helpText":"SAP Asset Name","type":"input","values":null,"isRequired":true,"options":{},"order":1},{"id":"inputs-input-2","label":"parameters","helpText":"SAP OData Parameters","type":"input","values":null,"isRequired":false,"options":{},"order":2},{"id":"inputs-input-3","label":"site_name","helpText":"SAP Site Name","type":"input","values":null,"isRequired":true,"options":{},"order":3},{"id":"inputs-input-4","label":"type","helpText":"analytical or relational","type":"input","values":null,"isRequired":true,"options":{},"order":4}],"persistData":"no"},{"id":"41D455E9-B904-43B6-81E8-3C28F9762A0D","type":"VariableBlock","disabled":false,"name":"accessToken","displayName":"Variable - accessToken","comment":"Set access token","childId":null,"inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-1067,"y":1484,"variableGuid":"38DAEF5B-20BA-4D99-B762-70F888749E8B","operations":[{"id":"set_value","key":"B3546E5C-BDBC-4F8B-966E-ED4B4C51F083","name":"Set value of { variable }","value":"{$.callURL.access_token}"}]},{"id":"E3A45D38-0A77-4980-A185-15954B2DA30B","type":"VariableBlock","disabled":false,"name":"accessToken","displayName":"Variable - accessToken","comment":"Set access token","childId":null,"inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":145,"y":2156,"variableGuid":"38DAEF5B-20BA-4D99-B762-70F888749E8B","operations":[{"id":"set_value","key":"B3546E5C-BDBC-4F8B-966E-ED4B4C51F083","name":"Set value of { variable }","value":"{$.readDataFromFile2.access_token}"}]},{"id":"3D6B8028-85D7-4A81-B5F1-0CF51C7C2B3B","type":"CallUrlBlock","disabled":false,"name":"callURL2","displayName":"Call URL 2","comment":"Get metadata","childId":"07A10BD8-7B3B-4A62-ACA5-5372A22B2BF2","inputs":[{"id":"url","value":"https://{$.inputs.site_name}.eu10.hcs.cloud.sap/api/v1/dwc/consumption/{$.inputs.type}/{$.inputs.space}/{$.inputs.asset}/$metadata","type":"string","structure":[]},{"id":"method","value":"GET","type":"select","structure":[]},{"id":"timeout","value":"","type":"string","structure":[]},{"id":"params","value":null,"type":"object","mode":"keyValue","structure":[]},{"id":"headers","value":[{"key":"Authorization","value":"Bearer {$.accessToken}"}],"type":"object","mode":"keyValue","structure":[]},{"id":"encoding","value":"","type":"string","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"full_response","value":null,"type":"checkbox","structure":[]},{"id":"capitalize_headers","value":true,"type":"checkbox","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-1047,"y":1994},{"id":"07A10BD8-7B3B-4A62-ACA5-5372A22B2BF2","type":"CustomCodeBlock3","disabled":false,"name":"customCode3","displayName":"Custom Code 3","comment":"Generate Qlik Script","childId":"47ABA3C4-6E9C-45B3-991A-6F0FC40F32C5","inputs":[{"id":"language","value":"python","type":"select","displayValue":"Python 3.11","structure":[]},{"id":"inputs","value":[{"key":"metadata","value":"{$.callURL2}"},{"key":"parameters","value":"{$.inputs.parameters}"},{"key":"access_token","value":"{$.accessToken}"}],"type":"object","mode":"keyValue","structure":[]},{"id":"code","value":"import xml.etree.ElementTree as ET\nimport urllib.parse\nimport json\n\n# XML content\nxml_content = inputs['metadata']\n\n# URL variable containing $select parameters\nurl_variable = inputs['parameters']\naccess_token = inputs['access_token']\n\ndef get_property_names(xml_content):\n    # Parse the XML content\n    tree = ET.ElementTree(ET.fromstring(xml_content))\n    root = tree.getroot()\n    # Define the namespaces\n    namespaces = {\n        'edmx': 'http://docs.oasis-open.org/odata/ns/edmx',\n        'edm': 'http://docs.oasis-open.org/odata/ns/edm'\n    }\n    # Find all Property elements under EntityType\n    properties = root.findall('.//edm:EntityType/edm:Property', namespaces)\n    # Get the Name attributes\n    property_names = [prop.get('Name') for prop in properties]\n    return property_names\n\ndef get_select_fields(url_variable):\n    parsed_url = urllib.parse.urlparse(url_variable)\n    query_params = urllib.parse.parse_qs(parsed_url.query)\n    select_fields = []\n    if '$select' in query_params:\n        select_params = query_params['$select'][0]\n        select_fields = select_params.split(',')\n    return select_fields\n\ndef generate_sections(property_names, select_fields=None):\n    if select_fields:\n        # Only include the fields in select_fields\n        fields_to_include = [field for field in property_names if field in select_fields]\n    else:\n        fields_to_include = property_names\n\n    # Generate the SQL SELECT section\n    sql_select_lines = ['\\t\"__KEY_root\",', '\\t(SELECT ']\n    for field in fields_to_include:\n        sql_select_lines.append(f'\\t\\t\"{field}\",')\n    sql_select_lines.append('\\t\\t\"__FK_value\"')\n    #sql_select_lines.append('\\tFROM \"value\" FK \"__FK_value\")')\n    #sql_select_lines.append('FROM JSON (wrap on) \"root\" PK \"__KEY_root\";')\n\n    sql_select_section = '\\n'.join(sql_select_lines)\n\n    # Generate the LOAD section\n    load_fields = ',\\n\\t'.join([f'[{field}]' for field in fields_to_include])\n    load_lines = [f'LOAD\\t{load_fields},']\n    load_lines.append('\\t[__FK_value] AS [__KEY_root]')\n    #load_lines.append('RESIDENT RestConnectorMasterTable')\n    #load_lines.append('WHERE NOT IsNull([__FK_value]);')\n\n    load_section = '\\n'.join(load_lines)\n\n    return {\n        'sql_select_section': sql_select_section,\n        'load_section': load_section,\n        'access_token': access_token\n    }\n\n# Main logic\nproperty_names = get_property_names(xml_content)\nselect_fields = get_select_fields(url_variable)\nsections = generate_sections(property_names, select_fields)\n\n# Output the JSON object\nprint(json.dumps(sections))","type":"code","structure":[]}],"settings":[{"id":"blendr_on_error","value":"stop","type":"select","structure":[]},{"id":"automations_censor_data","value":false,"type":"checkbox","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-322,"y":1779},{"id":"4B7549E7-99DF-4A35-A689-6CF50920739E","type":"ShowBlock","disabled":false,"name":"output","displayName":"Output","comment":"","childId":null,"inputs":[{"id":"input","value":"{$.response}","type":"string","structure":[]}],"settings":[{"id":"display_mode","value":"set","type":"select","displayValue":"Use only this output (overwrite previous outputs)","structure":[]}],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-33,"y":1934},{"id":"47ABA3C4-6E9C-45B3-991A-6F0FC40F32C5","type":"VariableBlock","disabled":false,"name":"response","displayName":"Variable - response","comment":"","childId":"4B7549E7-99DF-4A35-A689-6CF50920739E","inputs":[],"settings":[],"collapsed":[{"name":"loop","isCollapsed":false}],"x":-373,"y":1769,"variableGuid":"CA5176BB-CDAB-4FF2-826C-986DFEF05A14","operations":[{"id":"set_value","key":"2E3E82D9-4887-4A6F-8E0C-192457821D97","name":"Set value of { variable }","value":"{object: '{$.customCode3}'}"}]}],"variables":[{"guid":"7A6082F2-5144-4D46-B83F-82A5E1A12587","name":"clientId","type":"string"},{"guid":"21900FA7-28EB-4332-9988-F37BDAA932EB","name":"clientSecret","type":"string"},{"guid":"698B2084-AEC8-4D15-B075-202F61157239","name":"siteName","type":"string"},{"guid":"8249BD43-D54B-4F65-8461-6135162BEA1B","name":"filePath","type":"string"},{"guid":"AF0C6F5A-4D27-407F-B463-5EDEFC8F3F31","name":"dataConnectionName","type":"string"},{"guid":"7582E4D4-079A-4A7E-8A4C-5380E9DE1FD7","name":"dataConnection","type":"object"},{"guid":"38DAEF5B-20BA-4D99-B762-70F888749E8B","name":"accessToken","type":"string"},{"guid":"CA5176BB-CDAB-4FF2-826C-986DFEF05A14","name":"response","type":"string"}]}